<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Test Allocate API - Production</title>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 800px; margin: 0 auto; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin: 10px 5px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; }
        input { padding: 8px; width: 300px; margin: 5px; }
        label { display: inline-block; width: 120px; font-weight: bold; }
        .info { background: #e3f2fd; padding: 10px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üß™ Test Allocate API (Production)</h1>
    
    <div class="info">
        <strong>Server:</strong> http://diavatly.com/BHLD/api/<br>
        <strong>M·ª•c ƒë√≠ch:</strong> Test c·∫•p ph√°t thi·∫øt b·ªã tr√™n server th·∫≠t
    </div>
    
    <div>
        <label>M√£ ch·ª©ng t·ª´:</label>
        <input type="text" id="mact" value="2013-04-P07-16655">
    </div>
    <div>
        <label>M√£ v·∫≠t t∆∞:</label>
        <input type="number" id="mavt" value="500120">
    </div>
    <div>
        <label>Ng√†y nh·∫≠n:</label>
        <input type="date" id="ngnhan" value="2025-12-30">
    </div>
    
    <button onclick="testPing()">1. Test Server</button>
    <button onclick="checkTriggers()">2. Ki·ªÉm tra Triggers</button>
    <button onclick="viewTriggerDetails()">3. Chi ti·∫øt Triggers</button>
    <button onclick="showCurrentTriggers()">üìã Show Triggers Hi·ªán T·∫°i</button>
    <button onclick="generateFixedTriggers()">4. T·∫°o SQL Fix</button>
    <button onclick="testDebug()">5. Debug Data</button>
    <button onclick="testMethod()">üîç Test POST Method</button>
    <button onclick="testAllocate()">6. C·∫•p ph√°t (0‚Üí1)</button>
    <button onclick="testAllocateV2Direct()">6v2. Test Allocate V2 Direct</button>
    <button onclick="testAllocateTest()">6b. Test Allocate (Debug)</button>
    <button onclick="testDeallocate()">7. Thu h·ªìi (1‚Üí0)</button>
    <button onclick="clearResult()">X√≥a k·∫øt qu·∫£</button>
    
    <h2>K·∫øt qu·∫£:</h2>
    <div id="result"></div>
    
    <script>
        const BASE_URL = 'http://diavatly.com/BHLD/api';
        
        async function testPing() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p class="warning">ƒêang ki·ªÉm tra server...</p>';
            
            try {
                const response = await fetch(`${BASE_URL}/debug_allocate.php`);
                const data = await response.json();
                
                let html = `<p class="success"><strong>‚úÖ Server OK!</strong></p>`;
                html += `<p>C√≥ ${data.tests.available_to_allocate.count} thi·∫øt b·ªã c√≥ th·ªÉ c·∫•p ph√°t</p>`;
                html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå ERROR: ${error.message}</p>`;
            }
        }
        
        async function testDebug() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p class="warning">ƒêang l·∫•y d·ªØ li·ªáu debug...</p>';
            
            try {
                const response = await fetch(`${BASE_URL}/debug_allocate.php`);
                const data = await response.json();
                
                if (data.tests.simulation) {
                    const sim = data.tests.simulation;
                    document.getElementById('mact').value = sim.mact;
                    document.getElementById('mavt').value = sim.mavt;
                    document.getElementById('ngnhan').value = sim.ngnhan;
                    
                    let html = `<p class="success"><strong>‚úÖ ƒê√£ ƒëi·ªÅn d·ªØ li·ªáu m·∫´u</strong></p>`;
                    html += `<p><strong>SQL s·∫Ω th·ª±c thi:</strong></p>`;
                    html += `<pre>${sim.sql}</pre>`;
                    
                    resultDiv.innerHTML = html;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå ERROR: ${error.message}</p>`;
            }
        }
        
        async function testMethod() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p class="warning">üîÑ Testing POST method...</p>';
            
            const testData = { mact: '2013-04-P07-16655', mavt: 500120, ngnhan: '2025-12-30' };
            
            try {
                const response = await fetch(`${BASE_URL}/test_method.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                
                let html = `<p class="${data.method === 'POST' ? 'success' : 'error'}">`;
                html += `<strong>Method:</strong> ${data.method}<br>`;
                html += `<strong>Expected:</strong> POST<br>`;
                html += `<strong>Result:</strong> ${data.method === 'POST' ? '‚úÖ OK' : '‚ùå FAILED'}`;
                html += `</p>`;
                html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå ERROR: ${error.message}</p>`;
            }
        }
        
        async function testAllocate() {
            const mact = document.getElementById('mact').value;
            const mavt = parseInt(document.getElementById('mavt').value);
            const ngnhan = document.getElementById('ngnhan').value;
            
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p class="warning">üîÑ ƒêang c·∫•p ph√°t thi·∫øt b·ªã (0‚Üí1)...</p>';
            
            const body = { mact, mavt, ngnhan };
            
            try {
                const timestamp = Date.now();
                const response = await fetch(`${BASE_URL}/allocate_new.php?t=${timestamp}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                const data = await response.json();
                
                let html = `<p class="${data.success ? 'success' : 'error'}">`;
                html += `<strong>Status:</strong> ${response.status}<br>`;
                html += `<strong>Success:</strong> ${data.success}<br>`;
                html += `<strong>Message:</strong> ${data.message}<br>`;
                if (data.next_period_created) {
                    html += `<strong>‚úÖ ƒê√£ t·∫°o ch·ª©ng t·ª´ k·ª≥ sau:</strong> ${data.next_period_mact}`;
                }
                html += `</p>`;
                html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå ERROR: ${error.message}<br><br>File allocate_final.php ch∆∞a ƒë∆∞·ª£c upload l√™n server!</p>`;
            }
        }
        
        async function testAllocateV2Direct() {
            const mact = document.getElementById('mact').value;
            const mavt = parseInt(document.getElementById('mavt').value);
            const ngnhan = document.getElementById('ngnhan').value;
            
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p class="warning">üîÑ Testing allocate_v2.php DIRECT...</p>';
            
            const body = { mact, mavt, ngnhan };
            const url = 'http://diavatly.com/BHLD/api/allocate_new.php?direct=1&t=' + Date.now();
            
            resultDiv.innerHTML += `<p>Calling: ${url}</p>`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                const data = await response.json();
                
                let html = `<p class="${data.success ? 'success' : 'error'}">`;
                html += `<strong>Status:</strong> ${response.status}<br>`;
                html += `<strong>Success:</strong> ${data.success}<br>`;
                html += `<strong>Message:</strong> ${data.message}<br>`;
                if (data.message && data.message.includes('v2.0')) {
                    html += `<strong>‚úÖ API V2.0 CONFIRMED!</strong><br>`;
                }
                if (data.data && data.data.next_period) {
                    html += `<strong>‚úÖ Next Period:</strong> ${JSON.stringify(data.data.next_period)}<br>`;
                }
                html += `</p>`;
                html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå ERROR: ${error.message}</p>`;
            }
        }
        
        async function testAllocateTest() {
            const mact = document.getElementById('mact').value;
            const mavt = parseInt(document.getElementById('mavt').value);
            const ngnhan = document.getElementById('ngnhan').value;
            
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p class="warning">üîÑ Testing allocate_test.php...</p>';
            
            const body = { mact, mavt, ngnhan };
            
            try {
                const response = await fetch(`${BASE_URL}/allocate_test2.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                const data = await response.json();
                
                let html = `<p class="${data.success ? 'success' : 'error'}">`;
                html += `<strong>Status:</strong> ${response.status}<br>`;
                html += `<strong>Success:</strong> ${data.success}<br>`;
                html += `<strong>Message:</strong> ${data.message}`;
                html += `</p>`;
                
                if (data.data && data.data.next_period) {
                    const np = data.data.next_period;
                    html += `<h3>Next Period Info:</h3>`;
                    html += `<p>`;
                    html += `<strong>Step:</strong> ${np.step}<br>`;
                    html += `<strong>Master Created:</strong> ${np.master_created || false}<br>`;
                    html += `<strong>Detail Created:</strong> ${np.detail_created || false}<br>`;
                    html += `<strong>Next MACT:</strong> ${np.mact_next || 'N/A'}`;
                    html += `</p>`;
                }
                
                html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå ERROR: ${error.message}</p>`;
            }
        }
        
        async function testDeallocate() {
            const mact = document.getElementById('mact').value;
            const mavt = parseInt(document.getElementById('mavt').value);
            
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p class="warning">üîÑ ƒêang thu h·ªìi thi·∫øt b·ªã (1‚Üí0)...</p>';
            
            const body = { mact, mavt };
            
            try {
                const response = await fetch(`${BASE_URL}/deallocate_v2.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                const data = await response.json();
                
                let html = `<p class="${data.success ? 'success' : 'error'}">`;
                html += `<strong>Status:</strong> ${response.status}<br>`;
                html += `<strong>Success:</strong> ${data.success}<br>`;
                html += `<strong>Message:</strong> ${data.message}<br>`;
                if (data.next_period_deleted) {
                    html += `<strong>‚úÖ ƒê√£ x√≥a ch·ª©ng t·ª´ k·ª≥ sau:</strong> ${data.next_period_mact}`;
                }
                html += `</p>`;
                html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå ERROR: ${error.message}<br><br>File deallocate.php ch∆∞a ƒë∆∞·ª£c upload l√™n server!</p>`;
            }
        }

        
        async function checkTriggers() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p class="warning">ƒêang ki·ªÉm tra triggers...</p>';
            
            try {
                const response = await fetch(`${BASE_URL}/check_triggers.php`);
                const data = await response.json();
                
                let html = `<h3>Triggers tr√™n b·∫£ng bhld_ctctu:</h3>`;
                html += `<p><strong>S·ªë l∆∞·ª£ng:</strong> ${data.trigger_count}</p>`;
                html += `<p><strong>Table Engine:</strong> ${data.table_engine}</p>`;
                
                if (data.triggers && data.triggers.length > 0) {
                    html += `<p class="error"><strong>‚ö†Ô∏è C√ì TRIGGER S·ª¨ D·ª§NG JSON_OBJECT!</strong></p>`;
                    html += `<p>C√°c trigger n√†y c·∫ßn ƒë∆∞·ª£c x√≥a ho·∫∑c s·ª≠a:</p>`;
                    data.triggers.forEach(t => {
                        html += `<p><strong>${t.name}</strong> (${t.timing} ${t.event})</p>`;
                    });
                    
                    if (data.drop_commands) {
                        html += `<p><strong>L·ªánh ƒë·ªÉ x√≥a triggers:</strong></p>`;
                        html += `<pre>${data.drop_commands.join('\n')}</pre>`;
                    }
                } else {
                    html += `<p class="success">‚úÖ Kh√¥ng c√≥ trigger n√†o</p>`;
                }
                
                html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå ERROR: ${error.message}</p>`;
            }
        }
        
        function showCurrentTriggers() {
            // Open in new window - try simple test first
            window.open(`${BASE_URL}/test_triggers.php`, '_blank', 'width=1000,height=700');
        }
        
        async function viewTriggerDetails() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p class="warning">ƒêang l·∫•y chi ti·∫øt triggers...</p>';
            
            try {
                const response = await fetch(`${BASE_URL}/view_trigger_details.php`);
                const data = await response.json();
                
                if (!data.success) {
                    resultDiv.innerHTML = `<p class="error">‚ùå ERROR: ${data.error}</p>`;
                    return;
                }
                
                let html = `<h3>Chi ti·∫øt ${data.count} Triggers:</h3>`;
                
                data.triggers.forEach((trigger, index) => {
                    html += `<div style="border: 1px solid #ccc; margin: 10px 0; padding: 10px; background: #f9f9f9;">`;
                    html += `<h4>${index + 1}. ${trigger.name}</h4>`;
                    html += `<p><strong>Timing:</strong> ${trigger.timing} | <strong>Event:</strong> ${trigger.event}</p>`;
                    html += `<p><strong>Statement:</strong></p>`;
                    html += `<pre style="background: white; padding: 10px; overflow-x: auto; font-size: 11px;">`;
                    html += trigger.statement.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    html += `</pre></div>`;
                });
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå ERROR: ${error.message}</p>`;
            }
        }
        
        async function generateFixedTriggers() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p class="warning">ƒêang t·∫°o SQL fix triggers...</p>';
            
            try {
                const response = await fetch(`${BASE_URL}/generate_fixed_triggers.php`);
                const sqlText = await response.text();
                
                let html = `<h3>‚úÖ SQL Fix Triggers (MySQL 5.6 Compatible)</h3>`;
                html += `<p class="success" style="background: #dff0d8; padding: 10px; border-radius: 5px;">`;
                html += `üìã <strong>H∆∞·ªõng d·∫´n:</strong><br>`;
                html += `1. Click n√∫t "Copy SQL" b√™n d∆∞·ªõi<br>`;
                html += `2. M·ªü phpMyAdmin ‚Üí Ch·ªçn database "bhld_database"<br>`;
                html += `3. V√†o tab "SQL"<br>`;
                html += `4. Paste v√† Execute`;
                html += `</p>`;
                html += `<button onclick="copyToClipboard()" style="margin: 10px 0; padding: 10px 20px; font-size: 16px; background: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 5px;">üìã Copy SQL</button>`;
                html += `<pre id="sqlCode" style="background: #2d2d2d; color: #f8f8f2; padding: 15px; overflow-x: auto; font-size: 12px; font-family: Consolas, monospace; border-radius: 5px;">`;
                html += sqlText.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                html += `</pre>`;
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå ERROR: ${error.message}</p>`;
            }
        }
        
        function copyToClipboard() {
            const sqlCode = document.getElementById('sqlCode').innerText;
            navigator.clipboard.writeText(sqlCode).then(() => {
                alert('‚úÖ ƒê√£ copy SQL v√†o clipboard!');
            }).catch(err => {
                alert('‚ùå L·ªói copy: ' + err);
            });
        }
        
        async function testAllocateOld() {
            const mact = document.getElementById('mact').value;
            const mavt = parseInt(document.getElementById('mavt').value);
            const ngnhan = document.getElementById('ngnhan').value;
            
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p class="warning">ƒêang test API c≈©...</p>';
            
            const body = { mact, mavt, ngnhan };
            
            try {
                const response = await fetch(`${BASE_URL}/allocate.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                const data = await response.json();
                
                let html = `<p class="${data.success ? 'success' : 'error'}">`;
                html += `<strong>Status:</strong> ${response.status}<br>`;
                html += `<strong>Success:</strong> ${data.success}<br>`;
                html += `<strong>Message:</strong> ${data.message}`;
                html += `</p>`;
                html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                
                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå ERROR: ${error.message}</p>`;
            }
        }
        
        function clearResult() {
            document.getElementById('result').innerHTML = '';
        }
    </script>
</body>
</html>
