<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì§ M√¥ T·∫£: Tr·∫£ Thi·∫øt B·ªã (sl: 1 ‚Üí 0)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 30px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 40px;
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            border-left: 5px solid #f5576c;
        }
        
        .section h2 {
            color: #f5576c;
            margin-bottom: 20px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section h3 {
            color: #d32f2f;
            margin: 25px 0 15px 0;
            font-size: 1.3em;
        }
        
        .code-block {
            background: #282c34;
            color: #abb2bf;
            padding: 20px;
            border-radius: 10px;
            overflow-x: auto;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .code-block .keyword { color: #c678dd; }
        .code-block .string { color: #98c379; }
        .code-block .comment { color: #5c6370; font-style: italic; }
        .code-block .function { color: #61afef; }
        .code-block .variable { color: #e06c75; }
        
        .alert {
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid;
        }
        
        .alert-info {
            background: #d1ecf1;
            border-color: #0c5460;
            color: #0c5460;
        }
        
        .alert-warning {
            background: #fff3cd;
            border-color: #856404;
            color: #856404;
        }
        
        .alert-success {
            background: #d4edda;
            border-color: #155724;
            color: #155724;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        table th {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        table td {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            background: white;
        }
        
        table tr:hover td {
            background: #f1f3f5;
        }
        
        .flow-step {
            background: white;
            border: 2px solid #f5576c;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            position: relative;
        }
        
        .flow-step::before {
            content: "‚Üì";
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            color: #f5576c;
        }
        
        .flow-step:last-child::before {
            display: none;
        }
        
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin: 0 5px;
        }
        
        .badge-danger { background: #dc3545; color: white; }
        .badge-success { background: #28a745; color: white; }
        .badge-warning { background: #ffc107; color: #212529; }
        .badge-info { background: #17a2b8; color: white; }
        
        .highlight {
            background: #fff3cd;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .example-box {
            background: #ffe8e8;
            border: 2px solid #f5576c;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .comparison-item {
            padding: 20px;
            border-radius: 10px;
            border: 2px solid;
        }
        
        .before {
            background: #fff5f5;
            border-color: #dc3545;
        }
        
        .after {
            background: #f5fff5;
            border-color: #28a745;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì§ M√¥ T·∫£: Tr·∫£ Thi·∫øt B·ªã (sl: 1 ‚Üí 0)</h1>
            <p>Khi nh√¢n vi√™n tr·∫£ thi·∫øt b·ªã, h·ªá th·ªëng c·∫≠p nh·∫≠t record hi·ªán t·∫°i v√† X√ìA ch·ª©ng t·ª´ k·ª≥ sau</p>
            <p style="font-size: 0.9em; margin-top: 10px;">File: classes/bhld_ctctu.php | Function: Row_Updating()</p>
        </div>
        
        <div class="content">
            <!-- T·ªîNG QUAN -->
            <div class="section">
                <h2><span class="icon">üéØ</span>T·ªïng Quan</h2>
                
                <div class="alert alert-info">
                    <h3 style="margin-top: 0;">üìå Kh√°i ni·ªám "Tr·∫£ thi·∫øt b·ªã"</h3>
                    <p><strong>ƒê·ªãnh nghƒ©a:</strong> Khi nh√¢n vi√™n tr·∫£ thi·∫øt b·ªã tr∆∞·ªõc h·∫°n ho·∫∑c kh√¥ng c·∫ßn d√πng n·ªØa, admin s·ª≠a sl t·ª´ 1 (ƒë√£ nh·∫≠n) ‚Üí 0 (ch∆∞a nh·∫≠n/ƒë√£ tr·∫£).</p>
                    <br>
                    <p><strong>H·ªá th·ªëng s·∫Ω:</strong></p>
                    <ul style="margin: 15px 0 0 30px;">
                        <li>Reset ng√†y nh·∫≠n v·ªÅ gi√° tr·ªã m·∫∑c ƒë·ªãnh (1911-11-11)</li>
                        <li>X√ìA ch·ª©ng t·ª´ k·ª≥ sau (v√¨ kh√¥ng c·∫ßn t·∫°o k·ª≥ ti·∫øp theo n·ªØa)</li>
                    </ul>
                </div>
                
                <h3>V√≠ d·ª• minh h·ªça:</h3>
                <div class="example-box">
                    <p><strong>Th√°ng 11/2024:</strong> Nh√¢n vi√™n 17542 ƒë√£ nh·∫≠n "Kh·∫©u trang N95" (ƒë·ªãnh m·ª©c 3 th√°ng)</p>
                    <p style="margin-top: 10px;">‚Üí H·ªá th·ªëng ƒë√£ t·∫°o:</p>
                    <ul style="margin: 10px 0 0 30px;">
                        <li><strong>K·ª≥ hi·ªán t·∫°i (11/2024):</strong> sl=1, ngnhan='2024-11-15', ngnhantt='2025-02-15'</li>
                        <li><strong>K·ª≥ sau (02/2025):</strong> sl=0, ngnhan='1911-11-11' (ch·ªù nh·∫≠n)</li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Nh√¢n vi√™n tr·∫£ thi·∫øt b·ªã ng√†y 01/12/2024:</strong></p>
                    <p style="margin-top: 5px;">Admin s·ª≠a sl: 1 ‚Üí 0</p>
                    <ul style="margin: 10px 0 0 30px;">
                        <li>‚úÖ Reset k·ª≥ hi·ªán t·∫°i: sl=0, ngnhan='1911-11-11', ngnhantt='1911-11-11'</li>
                        <li>‚ùå X√≥a ch·ª©ng t·ª´ k·ª≥ sau (02/2025) - kh√¥ng c·∫ßn n·ªØa</li>
                    </ul>
                </div>
            </div>

            <!-- LU·ªíNG X·ª¨ L√ù -->
            <div class="section">
                <h2><span class="icon">üîÑ</span>Lu·ªìng X·ª≠ L√Ω Chi Ti·∫øt</h2>
                
                <div class="flow-step">
                    <h3 style="margin-top: 0;">B∆∞·ªõc 1: User c·∫≠p nh·∫≠t sl t·ª´ 1 ‚Üí 0</h3>
                    <p>Admin m·ªü trang chi ti·∫øt ch·ª©ng t·ª´, s·ª≠a s·ªë l∆∞·ª£ng t·ª´ 1 (ƒë√£ nh·∫≠n) ‚Üí 0 (tr·∫£/ch∆∞a nh·∫≠n)</p>
                    <table>
                        <tr>
                            <th>Field</th>
                            <th>Gi√° tr·ªã c≈©</th>
                            <th>Gi√° tr·ªã m·ªõi</th>
                        </tr>
                        <tr>
                            <td>sl</td>
                            <td>1</td>
                            <td>0</td>
                        </tr>
                        <tr>
                            <td>ngnhan</td>
                            <td>'2024-11-15'</td>
                            <td>(s·∫Ω ƒë∆∞·ª£c reset)</td>
                        </tr>
                        <tr>
                            <td>ngnhantt</td>
                            <td>'2025-02-15'</td>
                            <td>(s·∫Ω ƒë∆∞·ª£c reset)</td>
                        </tr>
                    </table>
                </div>
                
                <div class="flow-step">
                    <h3 style="margin-top: 0;">B∆∞·ªõc 2: Trigger Row_Updating()</h3>
                    <p>PHPMaker t·ª± ƒë·ªông g·ªçi function <code>Row_Updating($rsold, &$rsnew)</code></p>
                    <div class="code-block">
<span class="function">Row_Updating</span>(<span class="variable">$rsold</span>, &<span class="variable">$rsnew</span>) {
    <span class="comment">// $rsold: D·ªØ li·ªáu c≈© (sl=1, ngnhan='2024-11-15', ...)</span>
    <span class="comment">// $rsnew: D·ªØ li·ªáu m·ªõi (sl=0)</span>
}
                    </div>
                </div>
                
                <div class="flow-step">
                    <h3 style="margin-top: 0;">B∆∞·ªõc 3: Ki·ªÉm tra ƒëi·ªÅu ki·ªán</h3>
                    <div class="code-block">
<span class="keyword">if</span>(<span class="variable">$rsnew</span>[<span class="string">'sl'</span>]==<span class="number">0</span> && <span class="variable">$rsold</span>[<span class="string">'sl'</span>]!=<span class="number">0</span>) {
    <span class="comment">// Tr∆∞·ªùng h·ª£p: sl thay ƒë·ªïi t·ª´ 1 (ho·∫∑c >0) ‚Üí 0</span>
    <span class="comment">// ‚Üí Nh√¢n vi√™n TR·∫¢ thi·∫øt b·ªã</span>
}
                    </div>
                    <table>
                        <tr>
                            <th>ƒêi·ªÅu ki·ªán</th>
                            <th>√ù nghƒ©a</th>
                        </tr>
                        <tr>
                            <td><code>$rsnew['sl'] == 0</code></td>
                            <td>Gi√° tr·ªã m·ªõi l√† 0 (kh√¥ng c√≤n gi·ªØ thi·∫øt b·ªã)</td>
                        </tr>
                        <tr>
                            <td><code>$rsold['sl'] != 0</code></td>
                            <td>Gi√° tr·ªã c≈© kh√°c 0 (tr∆∞·ªõc ƒë√≥ ƒë√£ nh·∫≠n)</td>
                        </tr>
                    </table>
                </div>
                
                <div class="flow-step">
                    <h3 style="margin-top: 0;">B∆∞·ªõc 4: L·∫•y th√¥ng tin master record</h3>
                    <div class="code-block">
<span class="variable">$rs</span> = <span class="function">ExecuteRow</span>(<span class="string">"SELECT manv, mact, madm, mapb, ghichu, ngct, ...
       FROM bhld_ctu 
       WHERE mact='"</span>.<span class="variable">$rsold</span>[<span class="string">'mact'</span>].<span class="string">"'"</span>);
                    </div>
                    <p>L·∫•y th√¥ng tin ch·ª©ng t·ª´ cha ƒë·ªÉ bi·∫øt:</p>
                    <ul style="margin-left: 30px;">
                        <li><strong>manv:</strong> M√£ nh√¢n vi√™n</li>
                        <li><strong>mapb:</strong> M√£ ph√≤ng ban</li>
                        <li><strong>ngct:</strong> Ng√†y ch·ª©ng t·ª´</li>
                        <li><strong>dmtg:</strong> ƒê·ªãnh m·ª©c th·ªùi gian (t·ª´ $rsold)</li>
                    </ul>
                </div>
                
                <div class="flow-step">
                    <h3 style="margin-top: 0;">B∆∞·ªõc 5: Reset ng√†y nh·∫≠n v·ªÅ m·∫∑c ƒë·ªãnh</h3>
                    <div class="code-block">
<span class="variable">$rsnew</span>[<span class="string">'ngnhan'</span>] = <span class="string">'1911-11-11'</span>;
<span class="variable">$rsnew</span>[<span class="string">'ngnhantt'</span>] = <span class="string">'1911-11-11'</span>;
                    </div>
                    <div class="alert alert-warning">
                        <strong>‚ö†Ô∏è L∆∞u √Ω:</strong> Ng√†y '1911-11-11' l√† gi√° tr·ªã m·∫∑c ƒë·ªãnh bi·ªÉu th·ªã "ch∆∞a nh·∫≠n" ho·∫∑c "ƒë√£ tr·∫£"
                    </div>
                    <table>
                        <tr>
                            <th>Field</th>
                            <th>Gi√° tr·ªã c≈©</th>
                            <th>Gi√° tr·ªã m·ªõi</th>
                            <th>√ù nghƒ©a</th>
                        </tr>
                        <tr>
                            <td><strong>ngnhan</strong></td>
                            <td>'2024-11-15'</td>
                            <td class="highlight">'1911-11-11'</td>
                            <td>Reset v·ªÅ ch∆∞a nh·∫≠n</td>
                        </tr>
                        <tr>
                            <td><strong>ngnhantt</strong></td>
                            <td>'2025-02-15'</td>
                            <td class="highlight">'1911-11-11'</td>
                            <td>Reset v·ªÅ ch∆∞a c√≥ h·∫°n tr·∫£</td>
                        </tr>
                    </table>
                </div>
                
                <div class="flow-step">
                    <h3 style="margin-top: 0;">B∆∞·ªõc 6: Format m√£ nh√¢n vi√™n</h3>
                    <div class="code-block">
<span class="comment">// Format manv ƒë√∫ng: ch·ªâ th√™m s·ªë 0 khi l√† s·ªë thu·∫ßn v√† c√≥ 4 ch·ªØ s·ªë</span>
<span class="variable">$manv_formatted</span> = <span class="variable">$rs</span>[<span class="string">'manv'</span>];
<span class="keyword">if</span>(<span class="function">is_numeric</span>(<span class="variable">$rs</span>[<span class="string">'manv'</span>]) && <span class="function">strlen</span>(<span class="variable">$rs</span>[<span class="string">'manv'</span>])==<span class="number">4</span>) {
    <span class="variable">$manv_formatted</span> = <span class="string">'0'</span>.<span class="variable">$rs</span>[<span class="string">'manv'</span>];  <span class="comment">// VD: '1234' ‚Üí '01234'</span>
}
<span class="comment">// V·ªõi '17542' (5 ch·ªØ s·ªë) ho·∫∑c '08-DVL' (c√≥ k√Ω t·ª±) ‚Üí gi·ªØ nguy√™n</span>
                    </div>
                    <p>C·∫ßn format ƒë√∫ng m√£ nh√¢n vi√™n ƒë·ªÉ t·∫°o mact k·ª≥ sau ch√≠nh x√°c cho c√¢u DELETE</p>
                </div>
                
                <div class="flow-step">
                    <h3 style="margin-top: 0;">B∆∞·ªõc 7: X√ìA ch·ª©ng t·ª´ k·ª≥ sau</h3>
                    <div class="code-block">
<span class="comment">// T√≠nh mact c·ªßa ch·ª©ng t·ª´ k·ª≥ sau</span>
<span class="variable">$mact_ky_sau</span> = <span class="function">CONCAT</span>(
    <span class="function">date_format</span>(<span class="function">DATE_ADD</span>(<span class="variable">$rs</span>[<span class="string">'ngct'</span>], <span class="keyword">INTERVAL</span> <span class="variable">$rsold</span>[<span class="string">'dmtg'</span>] <span class="keyword">MONTH</span>), <span class="string">'%Y-%m'</span>),
    <span class="string">'-'</span>,
    <span class="variable">$rs</span>[<span class="string">'mapb'</span>],
    <span class="string">'-'</span>,
    <span class="variable">$manv_formatted</span>
);

<span class="comment">// DELETE detail record c·ªßa k·ª≥ sau</span>
<span class="variable">$sql</span> = <span class="string">"DELETE FROM `bhld_ctctu` 
       WHERE mact = '"</span>.<span class="variable">$mact_ky_sau</span>.<span class="string">"'
       AND mavt = "</span>.<span class="variable">$rsold</span>[<span class="string">'mavt'</span>];

<span class="function">Execute</span>(<span class="variable">$sql</span>);
                    </div>
                    
                    <h4>Gi·∫£i th√≠ch:</h4>
                    <table>
                        <tr>
                            <th>Th√†nh ph·∫ßn</th>
                            <th>C√¥ng th·ª©c</th>
                            <th>V√≠ d·ª•</th>
                        </tr>
                        <tr>
                            <td><strong>NƒÉm-Th√°ng k·ª≥ sau</strong></td>
                            <td>date_format(DATE_ADD('2024-11-15', 3 MONTH), '%Y-%m')</td>
                            <td>'2025-02'</td>
                        </tr>
                        <tr>
                            <td><strong>M√£ ph√≤ng ban</strong></td>
                            <td>$rs['mapb']</td>
                            <td>'PB01'</td>
                        </tr>
                        <tr>
                            <td><strong>M√£ NV format</strong></td>
                            <td>$manv_formatted</td>
                            <td>'17542'</td>
                        </tr>
                        <tr>
                            <td><strong>mact k·ª≥ sau</strong></td>
                            <td>CONCAT(...)</td>
                            <td><span class="badge badge-danger">2025-02-PB01-17542</span></td>
                        </tr>
                    </table>
                    
                    <div class="alert alert-info" style="margin-top: 20px;">
                        <strong>üí° T·∫°i sao ch·ªâ X√ìA detail (bhld_ctctu) m√† kh√¥ng x√≥a master (bhld_ctu)?</strong>
                        <br><br>
                        <p>V√¨ ch·ª©ng t·ª´ master (bhld_ctu) c√≥ th·ªÉ ch·ª©a nhi·ªÅu v·∫≠t t∆∞ kh√°c nhau. Ch·ªâ x√≥a v·∫≠t t∆∞ c·ª• th·ªÉ (mavt) m√† nh√¢n vi√™n tr·∫£, kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn c√°c v·∫≠t t∆∞ kh√°c.</p>
                        <br>
                        <p><strong>V√≠ d·ª•:</strong> Ch·ª©ng t·ª´ 2025-02-PB01-17542 c√≥ 3 v·∫≠t t∆∞:</p>
                        <ul style="margin: 10px 0 0 30px;">
                            <li>Kh·∫©u trang N95 (mavt=101) - Nh√¢n vi√™n TR·∫¢</li>
                            <li>GƒÉng tay (mavt=102) - V·∫´n gi·ªØ</li>
                            <li>√Åo b·∫£o h·ªô (mavt=103) - V·∫´n gi·ªØ</li>
                        </ul>
                        <p style="margin-top: 10px;">‚Üí Ch·ªâ DELETE record v·ªõi mavt=101, gi·ªØ l·∫°i 102 v√† 103</p>
                    </div>
                </div>
            </div>

            <!-- V√ç D·ª§ C·ª§ TH·ªÇ -->
            <div class="section">
                <h2><span class="icon">üí°</span>V√≠ D·ª• C·ª• Th·ªÉ</h2>
                
                <h3>T√¨nh hu·ªëng: Nh√¢n vi√™n 17542 tr·∫£ Kh·∫©u trang N95</h3>
                
                <h4>üìä D·ªØ li·ªáu TR∆Ø·ªöC khi tr·∫£ (sl: 1):</h4>
                
                <h5>B·∫£ng bhld_ctu (Master) - C√≥ 2 k·ª≥:</h5>
                <table>
                    <tr>
                        <th>mact</th>
                        <th>manv</th>
                        <th>ngct</th>
                        <th>mapb</th>
                        <th>Ghi ch√∫</th>
                    </tr>
                    <tr style="background: #fff3cd;">
                        <td>2024-11-PB01-17542</td>
                        <td>17542</td>
                        <td>2024-11-15</td>
                        <td>PB01</td>
                        <td><span class="badge badge-warning">K·ª≥ hi·ªán t·∫°i</span></td>
                    </tr>
                    <tr style="background: #d1ecf1;">
                        <td>2025-02-PB01-17542</td>
                        <td>17542</td>
                        <td>2025-02-15</td>
                        <td>PB01</td>
                        <td><span class="badge badge-info">K·ª≥ sau (s·∫Ω b·ªã x√≥a)</span></td>
                    </tr>
                </table>
                
                <h5>B·∫£ng bhld_ctctu (Detail) - C√≥ 2 k·ª≥:</h5>
                <table>
                    <tr>
                        <th>mact</th>
                        <th>mavt</th>
                        <th>sl</th>
                        <th>ngnhan</th>
                        <th>ngnhantt</th>
                        <th>dmtg</th>
                    </tr>
                    <tr style="background: #fff3cd;">
                        <td>2024-11-PB01-17542</td>
                        <td>101</td>
                        <td class="highlight">1</td>
                        <td>2024-11-15</td>
                        <td>2025-02-15</td>
                        <td>3</td>
                    </tr>
                    <tr style="background: #d1ecf1;">
                        <td>2025-02-PB01-17542</td>
                        <td>101</td>
                        <td>0</td>
                        <td>1911-11-11</td>
                        <td>1911-11-11</td>
                        <td>3</td>
                    </tr>
                </table>
                
                <h4 style="margin-top: 30px;">üìä D·ªØ li·ªáu SAU khi tr·∫£ (sl: 1 ‚Üí 0):</h4>
                
                <h5>B·∫£ng bhld_ctu (Master) - GI·ªÆ NGUY√äN:</h5>
                <table>
                    <tr>
                        <th>mact</th>
                        <th>manv</th>
                        <th>ngct</th>
                        <th>mapb</th>
                        <th>Ghi ch√∫</th>
                    </tr>
                    <tr>
                        <td>2024-11-PB01-17542</td>
                        <td>17542</td>
                        <td>2024-11-15</td>
                        <td>PB01</td>
                        <td><span class="badge badge-success">Gi·ªØ nguy√™n</span></td>
                    </tr>
                    <tr>
                        <td>2025-02-PB01-17542</td>
                        <td>17542</td>
                        <td>2025-02-15</td>
                        <td>PB01</td>
                        <td><span class="badge badge-success">Gi·ªØ nguy√™n (c√≥ th·ªÉ c√≥ v·∫≠t t∆∞ kh√°c)</span></td>
                    </tr>
                </table>
                
                <h5>B·∫£ng bhld_ctctu (Detail) - C·∫¨P NH·∫¨T v√† X√ìA:</h5>
                <table>
                    <tr>
                        <th>mact</th>
                        <th>mavt</th>
                        <th>sl</th>
                        <th>ngnhan</th>
                        <th>ngnhantt</th>
                        <th>dmtg</th>
                        <th>Thay ƒë·ªïi</th>
                    </tr>
                    <tr style="background: #d4edda;">
                        <td>2024-11-PB01-17542</td>
                        <td>101</td>
                        <td><strong>0</strong></td>
                        <td><strong>1911-11-11</strong></td>
                        <td><strong>1911-11-11</strong></td>
                        <td>3</td>
                        <td><span class="badge badge-success">‚úì C·∫¨P NH·∫¨T</span></td>
                    </tr>
                    <tr style="background: #f8d7da;">
                        <td colspan="7" style="text-align: center;">
                            <strong>‚ùå RECORD ƒê√É B·ªä X√ìA</strong><br>
                            <small>(2025-02-PB01-17542, mavt=101)</small>
                        </td>
                    </tr>
                </table>
            </div>

            <!-- SO S√ÅNH 0‚Üí1 vs 1‚Üí0 -->
            <div class="section">
                <h2><span class="icon">‚öñÔ∏è</span>So S√°nh: Nh·∫≠n (0‚Üí1) vs Tr·∫£ (1‚Üí0)</h2>
                
                <div class="comparison">
                    <div class="comparison-item before">
                        <h3>üì• Nh·∫≠n Thi·∫øt B·ªã (0‚Üí1)</h3>
                        <h4>H√†nh ƒë·ªông:</h4>
                        <ul>
                            <li>‚úÖ C·∫≠p nh·∫≠t record hi·ªán t·∫°i:
                                <ul>
                                    <li>sl = 1</li>
                                    <li>ngnhan = ng√†y hi·ªán t·∫°i</li>
                                    <li>ngnhantt = ngnhan + dmtg</li>
                                </ul>
                            </li>
                            <li>‚úÖ T·∫†O ch·ª©ng t·ª´ k·ª≥ sau (master + detail)</li>
                        </ul>
                        
                        <h4 style="margin-top: 20px;">M·ª•c ƒë√≠ch:</h4>
                        <p>Chu·∫©n b·ªã s·∫µn ch·ª©ng t·ª´ cho k·ª≥ tr·∫£/gia h·∫°n</p>
                    </div>
                    
                    <div class="comparison-item after">
                        <h3>üì§ Tr·∫£ Thi·∫øt B·ªã (1‚Üí0)</h3>
                        <h4>H√†nh ƒë·ªông:</h4>
                        <ul>
                            <li>‚úÖ C·∫≠p nh·∫≠t record hi·ªán t·∫°i:
                                <ul>
                                    <li>sl = 0</li>
                                    <li>ngnhan = '1911-11-11'</li>
                                    <li>ngnhantt = '1911-11-11'</li>
                                </ul>
                            </li>
                            <li>‚ùå X√ìA ch·ª©ng t·ª´ k·ª≥ sau (detail)</li>
                        </ul>
                        
                        <h4 style="margin-top: 20px;">M·ª•c ƒë√≠ch:</h4>
                        <p>H·ªßy b·ªè k·ª≥ sau v√¨ kh√¥ng c·∫ßn n·ªØa</p>
                    </div>
                </div>
            </div>

            <!-- CODE TH·ª∞C T·∫æ -->
            <div class="section">
                <h2><span class="icon">üíª</span>Code Th·ª±c T·∫ø</h2>
                
                <h3>File: classes/bhld_ctctu.php - Row_Updating() (Line ~1151-1167)</h3>
                <div class="code-block">
<span class="keyword">if</span>(<span class="variable">$rsnew</span>[<span class="string">'sl'</span>]==<span class="number">0</span> && <span class="variable">$rsold</span>[<span class="string">'sl'</span>]!=<span class="number">0</span>) {  <span class="comment">// Tr∆∞·ªùng h·ª£p s·ª≠a t·ª´ 1 ‚Üí 0</span>
    
    <span class="comment">// 1. Reset ng√†y nh·∫≠n v·ªÅ gi√° tr·ªã m·∫∑c ƒë·ªãnh</span>
    <span class="variable">$rsnew</span>[<span class="string">'ngnhan'</span>] = <span class="string">'1911-11-11'</span>;
    <span class="variable">$rsnew</span>[<span class="string">'ngnhantt'</span>] = <span class="string">'1911-11-11'</span>;
    
    <span class="comment">// 2. Format m√£ nh√¢n vi√™n ƒë√∫ng (ch·ªâ th√™m 0 n·∫øu l√† s·ªë thu·∫ßn 4 ch·ªØ s·ªë)</span>
    <span class="variable">$manv_formatted</span> = <span class="variable">$rs</span>[<span class="string">'manv'</span>];
    <span class="keyword">if</span>(<span class="function">is_numeric</span>(<span class="variable">$rs</span>[<span class="string">'manv'</span>]) && <span class="function">strlen</span>(<span class="variable">$rs</span>[<span class="string">'manv'</span>])==<span class="number">4</span>) {
        <span class="variable">$manv_formatted</span> = <span class="string">'0'</span>.<span class="variable">$rs</span>[<span class="string">'manv'</span>];
    }
    
    <span class="comment">// 3. X√ìA detail record c·ªßa ch·ª©ng t·ª´ k·ª≥ sau</span>
    <span class="variable">$sql</span> = <span class="string">"DELETE FROM `bhld_ctctu` 
           WHERE mact = CONCAT(
               date_format(DATE_ADD('"</span>.<span class="variable">$rs</span>[<span class="string">'ngct'</span>].<span class="string">"', INTERVAL "</span>.<span class="variable">$rsold</span>[<span class="string">'dmtg'</span>].<span class="string">" MONTH), '%Y-%m'),
               '-', '"</span>.<span class="variable">$rs</span>[<span class="string">'mapb'</span>].<span class="string">"',
               '-', '"</span>.<span class="variable">$manv_formatted</span>.<span class="string">"'
           )
           AND mavt = "</span>.<span class="variable">$rsold</span>[<span class="string">'mavt'</span>];
    
    <span class="function">Execute</span>(<span class="variable">$sql</span>);
}
                </div>
            </div>

            <!-- L∆ØU √ù -->
            <div class="section">
                <h2><span class="icon">‚ö†Ô∏è</span>L∆∞u √ù Quan Tr·ªçng</h2>
                
                <div class="alert alert-warning">
                    <h3 style="margin-top: 0;">1. Kh√¥ng x√≥a master record</h3>
                    <p>Ch·ªâ x√≥a detail record (bhld_ctctu) v√¨:</p>
                    <ul style="margin: 10px 0 0 30px;">
                        <li>Master c√≥ th·ªÉ ch·ª©a nhi·ªÅu v·∫≠t t∆∞ kh√°c</li>
                        <li>Tr√°nh ·∫£nh h∆∞·ªüng ƒë·∫øn c√°c v·∫≠t t∆∞ kh√°c c·ªßa c√πng nh√¢n vi√™n</li>
                    </ul>
                </div>
                
                <div class="alert alert-warning">
                    <h3 style="margin-top: 0;">2. Format m√£ nh√¢n vi√™n ch√≠nh x√°c</h3>
                    <p>C·∫ßn format ƒë√∫ng m√£ nh√¢n vi√™n ƒë·ªÉ DELETE ƒë√∫ng record:</p>
                    <ul style="margin: 10px 0 0 30px;">
                        <li>M√£ s·ªë 4 ch·ªØ s·ªë: '1234' ‚Üí '01234'</li>
                        <li>M√£ s·ªë 5 ch·ªØ s·ªë: '17542' ‚Üí '17542'</li>
                        <li>M√£ c√≥ k√Ω t·ª±: '08-DVL' ‚Üí '08-DVL'</li>
                    </ul>
                </div>
                
                <div class="alert alert-info">
                    <h3 style="margin-top: 0;">3. T·∫°i sao d√πng '1911-11-11'?</h3>
                    <p>ƒê√¢y l√† gi√° tr·ªã "magic value" bi·ªÉu th·ªã tr·∫°ng th√°i "ch∆∞a nh·∫≠n" ho·∫∑c "kh√¥ng x√°c ƒë·ªãnh":</p>
                    <ul style="margin: 10px 0 0 30px;">
                        <li>D·ªÖ nh·∫≠n bi·∫øt trong b√°o c√°o (nƒÉm 1911 r·∫•t c≈©)</li>
                        <li>Kh√¥ng b·ªã nh·∫ßm v·ªõi ng√†y th·ª±c t·∫ø</li>
                        <li>C√≥ th·ªÉ d√πng ƒë·ªÉ filter: WHERE ngnhan != '1911-11-11'</li>
                    </ul>
                </div>
            </div>

            <!-- T√ìM T·∫ÆT -->
            <div class="section">
                <h2><span class="icon">üìù</span>T√≥m T·∫Øt</h2>
                
                <div class="alert alert-success">
                    <h3 style="margin-top: 0;">‚úÖ Qu√° tr√¨nh tr·∫£ thi·∫øt b·ªã (sl: 1‚Üí0):</h3>
                    <ol style="margin: 15px 0 0 30px;">
                        <li><strong>Ki·ªÉm tra ƒëi·ªÅu ki·ªán:</strong> $rsnew['sl']==0 && $rsold['sl']!=0</li>
                        <li><strong>Reset ng√†y:</strong> ngnhan v√† ngnhantt v·ªÅ '1911-11-11'</li>
                        <li><strong>Format m√£ NV:</strong> Th√™m s·ªë 0 n·∫øu l√† s·ªë thu·∫ßn 4 ch·ªØ s·ªë</li>
                        <li><strong>T√≠nh mact k·ª≥ sau:</strong> NƒÉm-Th√°ng + dmtg + mapb + manv</li>
                        <li><strong>X√ìA detail:</strong> DELETE record k·ª≥ sau v·ªõi mact v√† mavt c·ª• th·ªÉ</li>
                    </ol>
                </div>
                
                <h3>Files li√™n quan:</h3>
                <ul style="margin-left: 30px;">
                    <li><strong>classes/bhld_ctctu.php</strong> - Row_Updating() (Line ~1151-1167)</li>
                    <li><strong>B·∫£ng bhld_ctu</strong> - Master table (kh√¥ng b·ªã x√≥a)</li>
                    <li><strong>B·∫£ng bhld_ctctu</strong> - Detail table (x√≥a record k·ª≥ sau)</li>
                </ul>
            </div>
        </div>
    </div>
</body>
</html>
